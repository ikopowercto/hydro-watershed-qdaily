<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Hydro Débits - Bassin Versant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 500px; }
    #controls { padding: 1em; }
  </style>
</head>
<body>
  <h1 style="text-align:center">Hydro Débits - Simulation</h1>
  <div id="map"></div>
  <div id="controls">
    <label>Coefficient de ruissellement (C): <input type="number" id="coef" value="0.5" step="0.05" min="0" max="1"></label><br>
    <label>Fraction souterraine (k): <input type="number" id="kfrac" value="0.2" step="0.05" min="0" max="1"></label><br>
    <button onclick="calculerDebits()">Calculer Débits Journaliers</button>
    <pre id="output"></pre>
  </div>

  <script>
    let map = L.map('map').setView([46.5, 2.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
    }).addTo(map);

    let outletMarker;
    let outletCoords;

    map.on('click', function(e) {
      if (outletMarker) map.removeLayer(outletMarker);
      outletCoords = e.latlng;
      outletMarker = L.marker(outletCoords).addTo(map).bindPopup("Exutoire").openPopup();
    });

    async function fetchWorldClim(month, lat, lng, res='10m') {
      const url = `https://biogeo.ucdavis.edu/data/worldclim/v2.1/base/wc2.1_${res}_prec_${month}.tif`;
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      const georaster = await parseGeoraster(arrayBuffer);
      let pixelValue = georaster.values[0][Math.floor(georaster.height/2)][Math.floor(georaster.width/2)];
      return pixelValue; // mm/mois
    }

    async function calculerDebits() {
      if (!outletCoords) {
        alert("Cliquez sur la carte pour définir l’exutoire.");
        return;
      }
      const C = parseFloat(document.getElementById('coef').value);
      const k = parseFloat(document.getElementById('kfrac').value);

      // Surface bassin fixe pour la démo (à remplacer par calcul bassin versant)
      const A_km2 = 100;
      const A_m2 = A_km2 * 1e6;

      let dailyP = [];
      let totalP = 0;

      for (let m = 1; m <= 12; m++) {
        const P_month = await fetchWorldClim(m, outletCoords.lat, outletCoords.lng);
        totalP += P_month;
        const daysInMonth = new Date(2000, m, 0).getDate();
        const P_day = P_month / daysInMonth;
        for (let d = 0; d < daysInMonth; d++) {
          dailyP.push(P_day);
        }
      }

      // Débit annuel moyen à partir des pluies
      let Vann = (totalP / 1000) * A_m2; // m3/an
      let Qann = Vann / (365 * 86400); // m3/s
      let Qb = k * Qann; // débit de base automatique

      let output = `Surface bassin: ${A_km2} km²\n\nDébits journaliers estimés (m3/s):\n`;
      dailyP.forEach((P_day, idx) => {
        let Q = C * (P_day/1000) * A_m2 / 86400 + Qb;
        output += `Jour ${idx+1}: ${Q.toFixed(3)}\n`;
      });
      document.getElementById('output').textContent = output;
    }

    // Import GeoRaster (nécessaire pour WorldClim)
    async function parseGeoraster(arrayBuffer) {
      return new Promise((resolve, reject) => {
        parseGeoraster(arrayBuffer).then(resolve).catch(reject);
      });
    }
  </script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
</body>
</html>
